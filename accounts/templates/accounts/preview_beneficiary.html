{% extends 'base.html' %}

{% block title %}Preview Beneficiary - {{ beneficiary.first_name }} {{ beneficiary.last_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-lg border-0 rounded-4">
                    <div class="card-header bg-success text-white text-center py-4 rounded-top-4">
                        <h1 class="mb-0"><i class="bi bi-person me-2"></i>Beneficiary Profile</h1>
                        <p class="mb-0">{{ beneficiary.first_name }} {{ beneficiary.last_name }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Profile Picture and Basic Info -->
            <div class="col-md-4">
                <div class="card shadow-lg border-0 rounded-4 mb-4">
                    <div class="card-body text-center p-4">
                        <h5 class="card-title mb-3">Profile Picture</h5>
                        {% if beneficiary.profile_picture %}
                            <img src="{{ beneficiary.profile_picture.url }}" alt="Profile Picture" class="img-fluid rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
                        {% else %}
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 150px; height: 150px;">
                                <i class="bi bi-person text-muted" style="font-size: 3rem;"></i>
                            </div>
                            <p class="text-muted">No profile picture.</p>
                        {% endif %}
                        <h6 class="text-primary">{{ beneficiary.admission_number }}</h6>
                    </div>
                </div>

                <!-- Brought By Information -->
                <div class="card shadow-lg border-0 rounded-4">
                    <div class="card-header bg-info text-white py-3 rounded-top-4">
                        <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>Brought By</h5>
                    </div>
                    <div class="card-body p-4">
                        <p><strong>Name:</strong> {{ beneficiary.brought_by.name }}</p>
                        <p><strong>Contact:</strong> {{ beneficiary.brought_by.contact|default:"N/A" }}</p>
                        <p><strong>ID Number:</strong> {{ beneficiary.brought_by.id_number|default:"N/A" }}</p>
                        <p><strong>Relationship:</strong> {{ beneficiary.brought_by.relationship|default:"N/A" }}</p>
                    </div>
                </div>
            </div>

            <!-- Detailed Information -->
            <div class="col-md-8">
                <!-- Personal Information -->
                <div class="card shadow-lg border-0 rounded-4 mb-4">
                    <div class="card-header bg-primary text-white py-3 rounded-top-4 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Personal Information</h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="toggleBeneficiaryEditMode()">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                    </div>
                    <div class="card-body p-4">
                        <!-- View Mode -->
                        <div id="beneficiary-view-mode">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Full Name:</strong> {{ beneficiary.first_name }} {{ beneficiary.middle_name|default:"" }} {{ beneficiary.last_name }}</p>
                                    <p><strong>Gender:</strong> {{ beneficiary.gender|title }}</p>
                                    <p><strong>Date of Birth:</strong> {{ beneficiary.date_of_birth|date:"M d, Y" }}</p>
                                    <p><strong>Age:</strong> {{ beneficiary.age|default:"N/A" }} years</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Admission Number:</strong> {{ beneficiary.admission_number }}</p>
                                    <p><strong>Date of Admission:</strong> {{ beneficiary.date_of_admission|date:"M d, Y" }}</p>
                                    <p><strong>Time of Admission:</strong> {{ beneficiary.time_of_admission|time:"H:i" }}</p>
                                    <p><strong>Residence Type:</strong> {{ beneficiary.residence_type|title }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div id="beneficiary-edit-mode" style="display: none;">
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="edit_beneficiary">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">First Name</label>
                                            <input type="text" class="form-control" name="first_name" value="{{ beneficiary.first_name }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Middle Name</label>
                                            <input type="text" class="form-control" name="middle_name" value="{{ beneficiary.middle_name|default:'' }}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Last Name</label>
                                            <input type="text" class="form-control" name="last_name" value="{{ beneficiary.last_name }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Gender</label>
                                            <select class="form-control" name="gender" required>
                                                <option value="male" {% if beneficiary.gender == 'male' %}selected{% endif %}>Male</option>
                                                <option value="female" {% if beneficiary.gender == 'female' %}selected{% endif %}>Female</option>
                                                <option value="other" {% if beneficiary.gender == 'other' %}selected{% endif %}>Other</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date of Birth</label>
                                            <input type="date" class="form-control" name="date_of_birth" value="{{ beneficiary.date_of_birth|date:'Y-m-d' }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Admission Number</label>
                                            <input type="text" class="form-control" name="admission_number" value="{{ beneficiary.admission_number }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date of Admission</label>
                                            <input type="date" class="form-control" name="date_of_admission" value="{{ beneficiary.date_of_admission|date:'Y-m-d' }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Time of Admission</label>
                                            <input type="time" class="form-control" name="time_of_admission" value="{{ beneficiary.time_of_admission|time:'H:i' }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Residence Type</label>
                                            <select class="form-control" name="residence_type" required>
                                                <option value="orphanage" {% if beneficiary.residence_type == 'orphanage' %}selected{% endif %}>Orphanage</option>
                                                <option value="foster_care" {% if beneficiary.residence_type == 'foster_care' %}selected{% endif %}>Foster Care</option>
                                                <option value="other" {% if beneficiary.residence_type == 'other' %}selected{% endif %}>Other</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Profile Picture</label>
                                            <input type="file" class="form-control" name="profile_picture">
                                            {% if beneficiary.profile_picture %}
                                                <small class="text-muted">Current: <a href="{{ beneficiary.profile_picture.url }}" target="_blank">{{ beneficiary.profile_picture.name }}</a></small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-success me-2">
                                        <i class="bi bi-check"></i> Save Changes
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="toggleBeneficiaryEditMode()">
                                        <i class="bi bi-x"></i> Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Educational Information -->
                <div class="card shadow-lg border-0 rounded-4 mb-4">
                    <div class="card-header bg-warning text-white py-3 rounded-top-4">
                        <h5 class="mb-0"><i class="bi bi-book me-2"></i>Educational Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>School Name:</strong> {{ beneficiary.school_name|default:"N/A" }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Class:</strong> {{ beneficiary.student_class|default:"N/A" }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Family Information -->
                <div class="card shadow-lg border-0 rounded-4 mb-4">
                    <div class="card-header bg-success text-white py-3 rounded-top-4">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Family Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Has Relatives:</strong> {% if beneficiary.has_relatives %}Yes ({{ beneficiary.relatives_count }}) {% else %}No{% endif %}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Has Siblings:</strong> {% if beneficiary.has_siblings %}Yes ({{ beneficiary.siblings_count }}) {% else %}No{% endif %}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Medical Records -->
                <div class="card shadow-lg border-0 rounded-4 mb-4">
                    <div class="card-header bg-info text-white py-3 rounded-top-4">
                        <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>Medical Records</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Add Medical Record Form -->
                        <div class="mb-4">
                            <h6 class="mb-3">Add New Medical Record</h6>
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
                                            {{ form.date }}
                                            {% if form.date.errors %}
                                                <div class="text-danger small">{{ form.date.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.doctor_name.id_for_label }}" class="form-label">Doctor Name</label>
                                            {{ form.doctor_name }}
                                            {% if form.doctor_name.errors %}
                                                <div class="text-danger small">{{ form.doctor_name.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.diagnosis.id_for_label }}" class="form-label">Diagnosis</label>
                                            {{ form.diagnosis }}
                                            {% if form.diagnosis.errors %}
                                                <div class="text-danger small">{{ form.diagnosis.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.treatment.id_for_label }}" class="form-label">Treatment</label>
                                            {{ form.treatment }}
                                            {% if form.treatment.errors %}
                                                <div class="text-danger small">{{ form.treatment.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <div class="text-danger small">{{ form.notes.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <button type="submit" class="btn btn-success rounded-pill px-4">
                                    <i class="bi bi-plus-circle me-2"></i>Add Medical Record
                                </button>
                            </form>
                        </div>

                        <hr class="my-4">

                        <!-- Medical Records List -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Medical Records History</h6>
                            <a href="{% url 'medical_records_list' beneficiary.id %}" class="btn btn-outline-primary btn-sm rounded-pill px-3">
                                <i class="bi bi-list me-1"></i>View All Records
                            </a>
                        </div>
                        {% if medical_records %}
                            <div class="row">
                                {% for record in medical_records|slice:":6" %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border" id="record-card-{{ record.id }}">
                                        <div class="card-body">
                                            <!-- View Mode -->
                                            <div id="view-mode-{{ record.id }}">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">{{ record.date|date:"M d, Y" }}</h6>
                                                    <small class="text-muted">Dr. {{ record.doctor_name }}</small>
                                                </div>
                                                <p class="card-text small mb-2"><strong>Diagnosis:</strong> {{ record.diagnosis }}</p>
                                                <p class="card-text small mb-2"><strong>Treatment:</strong> {{ record.treatment }}</p>
                                                {% if record.notes %}
                                                    <p class="card-text small mb-0"><strong>Notes:</strong> {{ record.notes }}</p>
                                                {% endif %}
                                                {% if record.medical_documents %}
                                                    <p class="card-text small mb-1"><strong>Documents:</strong> <a href="{{ record.medical_documents.url }}" target="_blank" class="text-decoration-none"><i class="bi bi-file-earmark"></i> View</a></p>
                                                {% endif %}
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-outline-warning btn-sm me-1" onclick="toggleEditMode({{ record.id }})">
                                                        <i class="bi bi-pencil"></i> Edit
                                                    </button>
                                                    <a href="{% url 'delete_medical_record' beneficiary.id record.id %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this medical record?')">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </a>
                                                </div>
                                            </div>

                                            <!-- Edit Mode -->
                                            <div id="edit-mode-{{ record.id }}" style="display: none;">
                                                <form id="edit-form-{{ record.id }}" method="post" enctype="multipart/form-data">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="record_id" value="{{ record.id }}">
                                                    <div class="mb-2">
                                                        <label class="form-label small">Date</label>
                                                        <input type="date" class="form-control form-control-sm" name="date" value="{{ record.date|date:'Y-m-d' }}" required>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Doctor Name</label>
                                                        <input type="text" class="form-control form-control-sm" name="doctor_name" value="{{ record.doctor_name }}" required>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Diagnosis</label>
                                                        <textarea class="form-control form-control-sm" name="diagnosis" rows="2" required>{{ record.diagnosis }}</textarea>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Treatment</label>
                                                        <textarea class="form-control form-control-sm" name="treatment" rows="2" required>{{ record.treatment }}</textarea>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Notes</label>
                                                        <textarea class="form-control form-control-sm" name="notes" rows="2">{{ record.notes }}</textarea>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label small">Medical Documents</label>
                                                        <input type="file" class="form-control form-control-sm" name="medical_documents">
                                                        {% if record.medical_documents %}
                                                            <small class="text-muted">Current: <a href="{{ record.medical_documents.url }}" target="_blank">{{ record.medical_documents.name }}</a></small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="mt-2">
                                                        <button type="submit" class="btn btn-success btn-sm me-1">
                                                            <i class="bi bi-check"></i> Save
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEditMode({{ record.id }})">
                                                            <i class="bi bi-x"></i> Cancel
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if medical_records|length > 6 %}
                                <p class="text-muted small">And {{ medical_records|length|add:"-6" }} more records...</p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No medical records found.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Documents -->
                {% if beneficiary.documents %}
                <div class="card shadow-lg border-0 rounded-4 mb-4">
                    <div class="card-header bg-secondary text-white py-3 rounded-top-4">
                        <h5 class="mb-0"><i class="bi bi-file-earmark me-2"></i>Documents</h5>
                    </div>
                    <div class="card-body p-4">
                        <a href="{{ beneficiary.documents.url }}" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-download me-2"></i>View Documents
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Back Button -->
                <div class="text-center">
                    <a href="{% url 'welfare_dashboard' %}" class="btn btn-secondary btn-lg rounded-pill px-4">
                        <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleEditMode(recordId) {
    const viewMode = document.getElementById('view-mode-' + recordId);
    const editMode = document.getElementById('edit-mode-' + recordId);

    if (editMode.style.display === 'none') {
        // Switch to edit mode
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    } else {
        // Switch to view mode
        editMode.style.display = 'none';
        viewMode.style.display = 'block';
    }
}

function toggleBeneficiaryEditMode() {
    const viewMode = document.getElementById('beneficiary-view-mode');
    const editMode = document.getElementById('beneficiary-edit-mode');

    if (editMode.style.display === 'none') {
        // Switch to edit mode
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    } else {
        // Switch to view mode
        editMode.style.display = 'none';
        viewMode.style.display = 'block';
    }
}
</script>
{% endblock %}
